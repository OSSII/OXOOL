#!/bin/sh

set -e

case "$1" in
    configure)
	setcap cap_net_bind_service=+ep /usr/bin/@PACKAGE_NAME@wsd || true
	setcap cap_fowner,cap_mknod,cap_sys_chroot=ep /usr/bin/@PACKAGE_NAME@forkit || true
	setcap cap_sys_admin=ep /usr/bin/@PACKAGE_NAME@mount || true

	fc-cache -f

	adduser --quiet --system --group --home /opt/@PACKAGE_NAME@ lool

	mkdir -p /var/cache/@PACKAGE_NAME@ && chown lool:lool /var/cache/@PACKAGE_NAME@
	rm -rf /var/cache/@PACKAGE_NAME@/*

	touch /var/log/@PACKAGE_NAME@wsd.log && chown lool:lool /var/log/@PACKAGE_NAME@wsd.log

	chown lool:root /etc/@PACKAGE_NAME@/@PACKAGE_NAME@wsd.xml
	chmod 640 /etc/@PACKAGE_NAME@/@PACKAGE_NAME@wsd.xml

	# We assume that the LibreOffice to be used is built TDF-style
	# and installs in @LO_PATH@, and that /opt/@PACKAGE_NAME@ is
	# on the same file system

	rm -rf /opt/@PACKAGE_NAME@
	mkdir -p /opt/@PACKAGE_NAME@/child-roots
	chown lool:lool /opt/@PACKAGE_NAME@
	chown lool:lool /opt/@PACKAGE_NAME@/child-roots

	fc-cache @LO_PATH@/share/fonts/truetype

	# rm -f /etc/systemd/system/@PACKAGE_NAME@wsd.service || true
	# ln -fs /lib/systemd/system/@PACKAGE_NAME@wsd.service /etc/systemd/system || true

	su lool --shell=/bin/sh -c "@PACKAGE_NAME@wsd-systemplate-setup /opt/@PACKAGE_NAME@/systemplate @LO_PATH@ >/dev/null 2>&1"
	;;

esac

#DEBHELPER#
