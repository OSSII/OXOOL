# syntax=docker/dockerfile:1
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

FROM ubuntu:20.04

# some descriptive metadata - docker image inspect
ARG author
LABEL author=${author:-"晟鑫科技 OSS Integral Institute Co., Ltd."}
LABEL description="OxOffice Online is a powerful collaborative Office suite that supports all major document, spreadsheet and presentation file formats, which you can integrate into your own infrastructure. OxOffice Online provides data security and sovereignty, and is ideally suited to the demands of a modern distributed working environment. Delivering a familiar look and feel, OxOffice Online represents a real alternative to other big-brands solutions, giving you control and flexibility."
ARG releasenotes
LABEL release.notes=${releasenotes:-"https://docs.ossii.com.tw/books/oxoffice-更新公告/page/oxoffice-online-社群版本更新公告"}
ARG version
LABEL version=${version:-"5.0.1-community-dev"}
ARG coretag
LABEL commit.history.core="https://git.libreoffice.org/core/+log/${coretag}"
ARG onlinetag
LABEL commit.history.online="https://github.com/OSSII/oxool-community/commits/${onlinetag}"

# UTF-8 locale is needed to handle file names with non-ASCII characters
ENV LC_CTYPE=C.UTF-8

RUN \
# Update repos before installing packages
    apt-get update && \
# Install dependencies of installer of OxOffice Online
    apt-get -y install cpio tzdata libcap2-bin apt-transport-https gnupg2 ca-certificates curl && \
# Setup OxOffice Online v4 repo(for the poco library)
    curl --output=/etc/apt/sources.list.d/oxool-community-v4-focal.list http://www.oxoffice.com.tw/deb/oxool-community-v4-focal.list && \
# Download OSSII package signing key
        curl http://www.oxoffice.com.tw/deb/OSSII.key | apt-key add \
# Update repos again
    apt-get update && \
# Install libpoco runtime dependencies
    apt-get install libpoco* -libpoco-dev
# Install OxOffice Online (OSSII Office is a dependency)
    apt-get -y install oxoolwsd \
# Install all dictionaries
                       oxoffice-dict-* \
# Install language packs
                       oxoffice-en-us \
                       oxoffice-zh-tw && \
# Fix ownership of config directory that will be modified on start of the container by lool user
    chown lool:lool /etc/oxoolwsd && \
# Remove perl-base, it's not needed and triggered some license scanner because of Paul Hsieh derivative license
    dpkg --purge  --force-remove-essential --ignore-depends=perl-base perl-base && \
# Cleanup
    rm -rf /var/lib/apt/* && \
# Remove WOPI Proof key generated by the package, we need unique key for each container
    rm -rf /etc/oxoolwsd/proof_key*

# FIXME
# Use the old starter script until we find out how to replace it.
COPY /scripts/start-oxoffice-online.sh /

# oxoolwsd listens on port 9980
EXPOSE 9980

# Switch to lool user (use numeric user id to be compatible with Kubernetes Pod Security Policies)
USER 100

# FIXME
# Use the old starter script until we find out how to replace it.
CMD ["/start-oxoolwsd-online.sh"]

