# syntax=docker/dockerfile:1
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

FROM rockylinux:8

# some descriptive metadata - docker image inspect
LABEL org.opencontainers.image.title="OxOffice Online(COMMUNITY-5)"
ARG author
LABEL org.opencontainers.image.authors=${author:-"晟鑫科技 OSS Integral Institute Co., Ltd."}
LABEL org.opencontainers.image.description="OxOffice Online is a powerful collaborative Office suite that supports all major document, spreadsheet and presentation file formats, which you can integrate into your own infrastructure. OxOffice Online provides data security and sovereignty, and is ideally suited to the demands of a modern distributed working environment. Delivering a familiar look and feel, OxOffice Online represents a real alternative to other big-brands solutions, giving you control and flexibility."
ARG releasenotes
LABEL release.notes=${releasenotes:-"https://docs.ossii.com.tw/books/oxoffice-更新公告/page/oxoffice-online-社群版本更新公告"}
ARG version
LABEL org.opencontainers.image.version=${version:-"5.0.1-community-dev"}
ARG coretag
LABEL commit.history.core="https://git.libreoffice.org/core/+log/${coretag}"
ARG onlinetag
LABEL commit.history.online="https://github.com/OSSII/oxool-community/commits/${onlinetag}"

# UTF-8 locale is needed to handle file names with non-ASCII characters
ENV LC_CTYPE=C.UTF-8

RUN --mount=type=bind,source=.,target=/build-context \
# Install dependencies for setting up external repositories
    dnf install -y curl && \
# Setup OxOffice Online v4 repo(only for the poco library)
    curl --output /etc/yum.repos.d/oxool-community-v4-el8.repo http://www.oxoffice.com.tw/rpm/el/oxool-community-v4-el8.repo && \
# Setup EPEL software repository(provides POCO's dependency)
    dnf install -y epel-release && \
# Install libpoco runtime dependencies
    dnf install -y poco-crypto poco-data poco-encodings poco-foundation poco-json poco-mongodb poco-mysql poco-net poco-netssl poco-odbc poco-pagecompiler poco-sqlite poco-util poco-xml poco-zip libiodbc && \
# Install OxOffice R10
    dnf install -y /build-context/oxoffice-10.*-dev/*.rpm && \
# Install built OxOffice Online V5 package
    dnf install -y /build-context/oxool-*.COMMUNITY.el8.*.rpm && \
# Install dependency for the start script
    dnf install -y openssl && \
# Fix ownership of config directory that will be modified on start of the container by lool user
    chown lool:lool /etc/oxool && \
# Cleanup
    dnf clean all && \
# Remove WOPI Proof key generated by the package, we need unique key for each container
    rm -rf /etc/oxool/proof_key*

COPY /scripts/docker-entrypoint.sh /docker-entrypoint.sh

# oxoolwsd listens on port 9980
EXPOSE 9980

# Switch to lool user (use numeric user id to be compatible with Kubernetes Pod Security Policies)
USER 998

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["/usr/bin/oxoolwsd", "--version", "--use-env-vars", "--o:sys_template_path=/opt/oxool/systemplate", "--o:child_root_path=/opt/oxool/child-roots", "--o:file_server_root_path=/usr/share/oxool", "--o:logging.color=false", "--o:stop_on_config_change=true"]

VOLUME ["/etc/oxool"]
